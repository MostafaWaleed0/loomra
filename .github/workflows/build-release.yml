name: ğŸš€ Build & Release

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release Type'
        required: true
        default: 'draft'
        type: choice
        options:
          - draft
          - prerelease
          - release
      version:
        description: 'Version (optional â€“ uses package.json if empty)'
        required: false
        type: string

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ” QUALITY CHECKS
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  quality:
    name: ğŸ” Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ” Type Check
        run: npx tsc --noEmit
        continue-on-error: false

      - name: ğŸ§¹ Lint
        run: npm run lint --if-present
        continue-on-error: false

      - name: ğŸ§ª Test
        run: npm test --if-present
        continue-on-error: false

      - name: ğŸ“Š Report
        if: always()
        run: |
          echo "### âœ… Quality Checks Complete" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed successfully!" >> $GITHUB_STEP_SUMMARY

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ—ï¸ BUILD ARTIFACTS
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  build:
    name: ğŸ—ï¸ Build ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    needs: quality
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.ref == 'refs/heads/main' ||
      startsWith(github.ref, 'refs/tags/v')
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows
            runner: windows-latest
            arch: x64
            target: win

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ Setup Python
        if: matrix.os == 'windows'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ” Environment Info
        run: |
          node --version
          npm --version

      - name: ğŸ’¾ Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-

      - name: ğŸ’¾ Cache Next.js
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ”¢ Set Version
        if: github.event.inputs.version != ''
        run: npm version ${{ github.event.inputs.version }} --no-git-tag-version --allow-same-version

      - name: âš™ï¸ Build Next.js
        run: npm run next:build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1

      - name: ğŸ—ï¸ Build Electron App
        run: npm run build:${{ matrix.target }}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          USE_HARD_LINKS: false

      - name: ğŸ“¦ List Build Artifacts
        shell: bash
        run: |
          echo "### ğŸ“¦ Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh dist/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Verify Artifacts
        shell: bash
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.exe 2>/dev/null)" ]; then
            echo "âŒ Error: No build artifacts found!"
            exit 1
          fi
          echo "âœ… Build artifacts verified"

      - name: ğŸ“¤ Upload Artifacts
        # Only upload artifacts if we're NOT immediately releasing
        # (Release job will use them from dist directly or download them)
        if: github.event_name != 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-${{ matrix.arch }}-installer
          retention-days: 3
          if-no-files-found: error
          compression-level: 9
          path: |
            dist/*.exe
            dist/*.yml
            dist/*.blockmap

      - name: ğŸ“Š Build Summary
        run: |
          echo "### âœ… Build Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| OS | ${{ matrix.os }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | ${{ matrix.arch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“¦ RELEASE
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  release:
    name: ğŸ“¦ Create Release
    runs-on: ubuntu-latest
    needs: build
    if: |
      github.event_name == 'workflow_dispatch' ||
      startsWith(github.ref, 'refs/tags/v')
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¥ Download All Artifacts
        if: github.event_name != 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/v')
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: ğŸ“‚ Use Build Artifacts from Previous Job
        if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: ğŸ“‹ List Downloaded Assets
        run: |
          echo "### ğŸ“‹ Release Assets" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          if [ -d "release-assets" ]; then
            ls -lhR release-assets/ >> $GITHUB_STEP_SUMMARY
          else
            echo "No release assets directory found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ” Determine Version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="v$(node -p "require('./package.json').version")"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Version: $VERSION" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ·ï¸ Determine Release Type
        id: release_type
        run: |
          TYPE="${{ github.event.inputs.release_type }}"
          VERSION="${{ steps.version.outputs.version }}"

          if [ -n "$TYPE" ]; then
            case "$TYPE" in
              draft)
                echo "is_draft=true" >> $GITHUB_OUTPUT
                echo "is_prerelease=false" >> $GITHUB_OUTPUT
                echo "ğŸ”– Type: Draft Release" >> $GITHUB_STEP_SUMMARY
                ;;
              prerelease)
                echo "is_draft=false" >> $GITHUB_OUTPUT
                echo "is_prerelease=true" >> $GITHUB_OUTPUT
                echo "ğŸ”– Type: Pre-release" >> $GITHUB_STEP_SUMMARY
                ;;
              release)
                echo "is_draft=false" >> $GITHUB_OUTPUT
                echo "is_prerelease=false" >> $GITHUB_OUTPUT
                echo "ğŸ”– Type: Stable Release" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
          else
            if [[ "$VERSION" =~ -beta|-alpha|-rc ]]; then
              echo "is_draft=false" >> $GITHUB_OUTPUT
              echo "is_prerelease=true" >> $GITHUB_OUTPUT
              echo "ğŸ”– Type: Pre-release (auto-detected)" >> $GITHUB_STEP_SUMMARY
            else
              echo "is_draft=false" >> $GITHUB_OUTPUT
              echo "is_prerelease=false" >> $GITHUB_OUTPUT
              echo "ğŸ”– Type: Stable Release (auto-detected)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: ğŸ“ Generate Release Notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          if [ -f "release_notes.md" ]; then
            NOTES=$(cat release_notes.md)
          else
            NOTES="## ğŸ‰ What's New in $VERSION

          ### ğŸ“¦ Installation
          Download the appropriate installer for your platform below.

          ### ğŸ“‹ Changelog
          For detailed changes, see the [commit history](https://github.com/${{ github.repository }}/commits/$VERSION).

          ---
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/...${VERSION}"
          fi

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸš€ Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Loomra ${{ steps.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: ${{ steps.release_type.outputs.is_draft }}
          prerelease: ${{ steps.release_type.outputs.is_prerelease }}
          files: release-assets/**/*
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: ğŸ“Š Release Summary
        run: |
          echo "### ğŸ‰ Release Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Draft | ${{ steps.release_type.outputs.is_draft }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-release | ${{ steps.release_type.outputs.is_prerelease }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ§¹ CLEANUP
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  cleanup:
    name: ğŸ§¹ Cleanup Artifacts
    runs-on: ubuntu-latest
    needs: [build, release]
    if: always() && needs.build.result == 'success'
    timeout-minutes: 5

    permissions:
      actions: write

    steps:
      - name: ğŸ—‘ï¸ Delete Build Artifacts (After Release)
        if: needs.release.result == 'success'
        uses: geekyeggo/delete-artifact@v5
        with:
          name: '*-installer'
          failOnError: false

      - name: ğŸ—‘ï¸ Delete Build Artifacts (On Main Push)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: geekyeggo/delete-artifact@v5
        with:
          name: '*-installer'
          failOnError: false

      - name: âœ… Cleanup Summary
        run: |
          echo "### âœ… Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "Build artifacts have been removed to save storage." >> $GITHUB_STEP_SUMMARY

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“Š STATUS REPORT
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  status:
    name: ğŸ“Š Workflow Status
    runs-on: ubuntu-latest
    needs: [quality, build, release]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ğŸ“‹ Generate Status Report
        run: |
          echo "## ğŸ“Š Workflow Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Quality
          if [ "${{ needs.quality.result }}" = "success" ]; then
            echo "| Quality Checks | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Quality Checks | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Build
          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "| Build | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build.result }}" = "skipped" ]; then
            echo "| Build | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Build | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Release
          if [ "${{ needs.release.result }}" = "success" ]; then
            echo "| Release | âœ… Published |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.release.result }}" = "skipped" ]; then
            echo "| Release | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Release | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Success Message
        if: needs.quality.result == 'success' && (needs.build.result == 'success' || needs.build.result == 'skipped')
        run: |
          echo "### âœ… Workflow Completed Successfully!" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.release.result }}" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ **Release has been published!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“¦ [View Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build.result }}" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“¦ **Build artifacts are ready!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Artifacts are available for download (7 days retention)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: âŒ Failure Message
        if: needs.quality.result == 'failure' || needs.build.result == 'failure' || needs.release.result == 'failure'
        run: |
          echo "### âŒ Workflow Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.quality.result }}" = "failure" ]; then
            echo "**Quality checks failed.** Please fix linting, type errors, or test failures." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build.result }}" = "failure" ]; then
            echo "**Build failed.** Check the build logs for errors." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.release.result }}" = "failure" ]; then
            echo "**Release failed.** The build was successful but release creation failed." >> $GITHUB_STEP_SUMMARY
          fi

          exit 1
